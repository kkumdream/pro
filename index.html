<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>ë…¸ì›êµ¬ ê¿ˆë“œë¦¼ | ê²€ì •ê³ ì‹œ ë¬¸ì œ í’€ì´</title>
  <style>
    :root{
      --bg:#0b0b0d; --panel:#121216; --muted:#1a1b22; --ink:#e8e8ef; --ink-dim:#b6b6c6; --accent:#9aa0ff;
      --good:#4cc38a; --bad:#ef5f76; --border:#2a2b36; --yellow:#ffd666;
    }
    *{box-sizing:border-box}
    html,body{height:100%}
    body{margin:0;background:var(--bg);color:var(--ink);font-family:system-ui,-apple-system,Segoe UI,Roboto,Pretendard,Apple SD Gothic Neo,sans-serif;}
    a{color:var(--accent);text-decoration:none}
    .app{max-width:960px;margin:0 auto;padding:24px}
    header{display:flex;align-items:center;justify-content:space-between;margin-bottom:16px}
    .brand{font-weight:800;letter-spacing:0.2px}
    .brand small{display:block;color:var(--ink-dim);font-weight:600;opacity:.8}
    .tabs{display:flex;gap:8px;background:var(--panel);padding:6px;border-radius:12px;border:1px solid var(--border)}
    .tab{padding:10px 14px;border-radius:10px;cursor:pointer;color:var(--ink-dim)}
    .tab.active{background:var(--muted);color:var(--ink);}

    .filters{display:grid;grid-template-columns:repeat(4,1fr);gap:8px;margin:16px 0}
    .filters .field{display:flex;flex-direction:column;gap:6px}
    select,button,input[type="text"]{background:var(--panel);color:var(--ink);border:1px solid var(--border);border-radius:10px;padding:10px}
    button{cursor:pointer}
    button.primary{background:var(--accent);color:#0a0b11;border-color:transparent;font-weight:700}
    button.ghost{background:transparent;border-color:var(--border);}

    .panel{background:var(--panel);border:1px solid var(--border);border-radius:14px;padding:16px}
    .passage{background:#0f1016;border-left:3px solid var(--border);padding:12px;border-radius:8px}
    .passage h4{margin:0 0 6px 0;color:var(--ink-dim);font-weight:700}
    .passage pre{white-space:pre-wrap;font-family:inherit;line-height:1.6;margin:0}

    .question{border:1px solid var(--border);border-radius:12px;padding:14px;background:#0f1014}
    .q-head{display:flex;align-items:flex-start;justify-content:space-between;gap:8px}
    .q-num{font-weight:800;color:var(--yellow)}
    .stem{line-height:1.65;margin:10px 0}
    .choices{display:grid;gap:8px}
    .choice{border:1px solid var(--border);border-radius:10px;padding:10px;cursor:pointer;background:#10121a}
    .choice.selected{outline:2px solid var(--accent);}
    .choice.correct{border-color:rgba(76,195,138,.6);background:rgba(76,195,138,.08)}
    .choice.incorrect{border-color:rgba(239,95,118,.6);background:rgba(239,95,118,.08)}

    .explain{margin-top:8px;padding:10px;border:1px dashed var(--border);border-radius:10px;background:#0f1118;color:var(--ink-dim)}
    .nav-row{display:flex;justify-content:space-between;gap:8px;margin-top:12px}

    .summary{display:flex;gap:10px;flex-wrap:wrap;margin:10px 0}
    .badge{padding:6px 10px;border-radius:999px;border:1px solid var(--border);background:#0f1118}
    .badge.bad{border-color:rgba(239,95,118,.6);color:#ffc7d0;cursor:pointer}
    .badge.good{border-color:rgba(76,195,138,.6);color:#b5ffdf}

    .help{color:var(--ink-dim);font-size:.9rem}
    .muted{color:var(--ink-dim)}

    .hidden{display:none !important}
  </style>
</head>
<body>
  <div class="app">
    <header>
      <div class="brand">ë…¸ì›êµ¬ ê¿ˆë“œë¦¼<small>ê²€ì •ê³ ì‹œ ë¬¸ì œ í’€ì´</small></div>
      <div class="help">í•„í„°ë¡œ ê²€ìƒ‰í•´ ì›í•˜ëŠ” íšŒì°¨Â·ê³¼ëª©ì„ ì„ íƒí•´ ì‹œì‘í•˜ì„¸ìš”.</div>
    </header>

    <div class="tabs" id="modeTabs">
      <div class="tab active" data-mode="practice">1ë¬¸ì œì”© í’€ê¸°</div>
      <div class="tab" data-mode="exam">ì‹œí—˜ìœ¼ë¡œ í’€ê¸°</div>
    </div>

    <section class="panel" id="home">
      <div class="filters">
        <div class="field">
          <label>í•­ëª©</label>
          <select id="fType">
            <option value="ê¸°ì¶œ" selected>ê¸°ì¶œ</option>
            <option value="ëª¨ì˜ê³ ì‚¬">ëª¨ì˜ê³ ì‚¬</option>
          </select>
        </div>
        <div class="field">
          <label>ë‚œì´ë„</label>
          <select id="fLevel">
            <option value="ê³ ì¡¸" selected>ê³ ì¡¸</option>
            <option value="ì¤‘ì¡¸">ì¤‘ì¡¸</option>
            <option value="ì´ˆì¡¸">ì´ˆì¡¸</option>
          </select>
        </div>
        <div class="field">
          <label>ì—°ë„</label>
          <input id="fYear" type="text" placeholder="ì˜ˆ) 2025 (ë¹„ìš°ë©´ ì „ì²´)" />
        </div>
        <div class="field">
          <label>ê³¼ëª©</label>
          <input id="fSubject" type="text" placeholder="ì˜ˆ) êµ­ì–´ (ë¹„ìš°ë©´ ì „ì²´)" />
        </div>
      </div>
      <div style="display:flex;gap:8px;align-items:center">
        <button class="primary" id="btnSearch">ê²€ìƒ‰</button>
        <span class="muted">manifest.jsonì„ ê¸°ì¤€ìœ¼ë¡œ ê²€ìƒ‰í•©ë‹ˆë‹¤.</span>
      </div>

      <div id="resultList" style="margin-top:14px"></div>
    </section>

    <section class="panel hidden" id="runner">
      <div id="runnerHeader" class="muted" style="margin-bottom:8px"></div>
      <div id="quizArea"></div>
      <div id="examFooter" class="hidden" style="margin-top:12px;display:flex;gap:8px">
        <button id="btnGradeBottom" class="primary">ì±„ì í•˜ê¸°</button>
        <button id="btnBackHome2" class="ghost">í™ˆìœ¼ë¡œ</button>
      </div>
    </section>
  </div>

<script>
(function(){
  const state = {
    mode: 'practice', // 'practice' | 'exam'
    data: null, // loaded JSON
    answers: {}, // exam answers
    current: 0, // index for practice
    shownPassageId: null // to avoid repeating in exam blocks
  };

  // --- helpers ---
  const $ = sel => document.querySelector(sel);
  function htmlEscape(s){ return s.replace(/[&<>]/g, ch => ({'&':'&amp;','<':'&lt;','>':'&gt;'}[ch])) }
  // prettify x^2 -> x<sup>2</sup>, a^10 etc
  function prettifyMath(s){
    return s
      .replace(/\^\{?(\d+)\}?/g, '<sup>$1</sup>')
      .replace(/([A-Za-zê°€-í£0-9])\^([A-Za-zê°€-í£0-9])/g, '$1<sup>$2</sup>');
  }
  function renderRich(text){
    if(!text) return '';
    // allow simple inline HTML like <u> and <img>
    let t = text
      .replace(/\n/g,'\n')
      .replace(/\*\*(.*?)\*\*/g,'<strong>$1</strong>');
    t = prettifyMath(t);
    return t;
  }

  function loadDefaultPath(){
    // Try default path for demo
    return fetch('data/2025/2ì°¨/ê³ ì¡¸/êµ­ì–´.json').then(r=>r.ok?r.json():null).catch(()=>null);
  }

  function showHome(){
    $('#home').classList.remove('hidden');
    $('#runner').classList.add('hidden');
    $('#examFooter').classList.add('hidden');
    $('#resultList').innerHTML = '';
  }

  // --- tabs ---
  Array.from(document.querySelectorAll('.tab')).forEach(tab=>{
    tab.addEventListener('click',()=>{
      Array.from(document.querySelectorAll('.tab')).forEach(t=>t.classList.remove('active'));
      tab.classList.add('active');
      state.mode = tab.dataset.mode;
      // íƒ­ì„ ëˆ„ë¥´ë©´ í™ˆìœ¼ë¡œ ì´ë™
      showHome();
    });
  });

  // --- manifest search ---
  async function fetchManifest(){
    try {
      const r = await fetch('manifest.json');
      if(!r.ok) return [];
      const json = await r.json();
      return Array.isArray(json) ? json : (json.items||[]);
    } catch(e){ return []; }
  }

  function renderResultItem(item){
    const div = document.createElement('div');
    div.className = 'question';
    div.innerHTML = `
      <div class="q-head"><div>
        <div class="muted">${htmlEscape(item.type||'ì„¸íŠ¸')}</div>
        <div><strong>${htmlEscape(item.year+'ë…„ '+item.round)} ${htmlEscape(item.level)} ${htmlEscape(item.subject)}</strong></div>
      </div>
      <button class="primary">ì‹œì‘</button></div>`;
    div.querySelector('button').addEventListener('click', async ()=>{
      try{
        const res = await fetch(item.path);
        if(!res.ok) throw new Error('ë¡œë“œ ì‹¤íŒ¨');
        const json = await res.json();
        onDataLoaded(json, `${item.year} ${item.round} ${item.subject}`);
      }catch(err){
        alert('ì„¸íŠ¸ ë¡œë“œì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤. ê²½ë¡œ: '+item.path);
      }
    });
    return div;
  }

  $('#btnSearch').addEventListener('click', async ()=>{
    const type = $('#fType').value.trim();
    const level = $('#fLevel').value.trim();
    const year = $('#fYear').value.trim();
    const subject = $('#fSubject').value.trim();

    const manifest = await fetchManifest();
    const results = manifest.filter(it=>
      (!type || it.type===type) &&
      (!level || it.level===level) &&
      (!year || String(it.year)===String(year)) &&
      (!subject || (it.subject||'').includes(subject))
    );

    const list = $('#resultList');
    list.innerHTML = '';
    if(results.length===0){
      list.innerHTML = '<div class="muted">ê²€ìƒ‰ ê²°ê³¼ê°€ ì—†ìŠµë‹ˆë‹¤. í•„í„°ë¥¼ ì¡°ì •í•´ ë³´ì„¸ìš”.</div>';
      return;
    }
    results.forEach(item=> list.appendChild(renderResultItem(item)) );
  });
    if(!json){
      $('#resultList').innerHTML = `<div class="muted">í•´ë‹¹ ì¡°ê±´ì˜ ë¡œì»¬ ë°ì´í„°ë¥¼ ëª» ì°¾ì•˜ìŠµë‹ˆë‹¤. JSON ë¶ˆëŸ¬ì˜¤ê¸°ë¥¼ ì´ìš©í•˜ì„¸ìš”.</div>`;
      return;
    }
    $('#resultList').innerHTML = '';
    const item = document.createElement('div');
    item.className = 'question';
    item.innerHTML = `
      <div class="q-head"><div>
        <div class="muted">${htmlEscape(json.meta.source||'ì„¸íŠ¸')}</div>
        <div><strong>${htmlEscape(json.meta.year+'ë…„ '+json.meta.round)} ${htmlEscape(json.meta.level)} ${htmlEscape(json.meta.subject)}</strong> Â· ë¬¸í•­ ${json.meta.count}</div>
      </div>
      <button class="primary" id="btnStart">ì‹œì‘</button></div>
    `;
    $('#resultList').appendChild(item);
    $('#btnStart').addEventListener('click',()=>onDataLoaded(json, `${json.meta.year} ${json.meta.round} ${json.meta.subject}`));
  });

  function onDataLoaded(json, title){
    state.data = normalize(json);
    state.current = 0;
    state.answers = {};
    $('#runnerHeader').textContent = title || (json?.meta?.source || 'ì„¸íŠ¸');
    $('#home').classList.add('hidden');
    $('#runner').classList.remove('hidden');
    render();
  }

  // Normalize optional fields
  function normalize(d){
    d.passagesById = {};
    (d.passages||[]).forEach(p=>d.passagesById[p.id]=p);
    d.questions = (d.questions||[]).map(q=>({
      number: q.number,
      stem: q.stem || q.question || '',
      choices: q.choices || q.options || [],
      answerIndex: typeof q.answerIndex==='number' ? q.answerIndex : (typeof q.answer==='number'? q.answer : 0),
      explanation: q.explanation||'',
      passageId: q.passageId||null,
      images: q.images||[]
    }));
    return d;
  }

  // --- rendering ---
  function render(){
    const area = $('#quizArea');
    area.innerHTML='';
    if(state.mode==='practice'){
      $('#examFooter').classList.add('hidden');
      renderPractice(area);
    }else{
      renderExam(area);
      $('#examFooter').classList.remove('hidden');
    }
  }

  function renderPassageBlock(passage){
    if(!passage) return '';
    return `<div class="passage"><h4>${passage.title||'ê³µí†µ ì§€ë¬¸'}</h4><pre>${renderRich(passage.text)}</pre></div>`;
  }

  function renderPractice(area){
    const q = state.data.questions[state.current];
    if(!q){ area.innerHTML = '<div class="muted">ë¬¸í•­ì´ ì—†ìŠµë‹ˆë‹¤.</div>'; return; }

    // passage
    if(q.passageId){
      const p = state.data.passagesById[q.passageId];
      area.insertAdjacentHTML('beforeend', renderPassageBlock(p));
    }

    const card = document.createElement('div');
    card.className = 'question';
    card.innerHTML = `
      <div class="q-head"><div class="q-num">ë¬¸í•­ ${q.number}</div></div>
      <div class="stem">${renderRich(q.stem)}</div>
      <div class="choices"></div>
      <div class="explain hidden"></div>
      <div class="nav-row">
        <button class="ghost" id="prevBtn">ì´ì „</button>
        <div style="flex:1"></div>
        <button class="ghost" id="nextBtn">ë‹¤ìŒ</button>
        <button class="primary" id="homeBtn">í™ˆìœ¼ë¡œ</button>
      </div>
    `;
    area.appendChild(card);

    const choicesEl = card.querySelector('.choices');
    q.choices.forEach((c,i)=>{
      const item = document.createElement('div');
      item.className = 'choice';
      item.innerHTML = renderRich(c);
      item.addEventListener('click', ()=>{
        // ì¦‰ì‹œ ì •ë‹µ/í•´ì„¤ ë…¸ì¶œ
        const correct = i===q.answerIndex;
        Array.from(choicesEl.children).forEach(ch=>ch.classList.remove('selected','correct','incorrect'));
        item.classList.add('selected', correct?'correct':'incorrect');
        if(!correct){
          // ì •ë‹µ í‘œì‹œ
          choicesEl.children[q.answerIndex].classList.add('correct');
        }
        const ex = card.querySelector('.explain');
        ex.classList.remove('hidden');
        ex.innerHTML = `<div><strong>${correct? 'ì •ë‹µ!':'ì˜¤ë‹µ'}</strong> Â· ì •ë‹µì€ <strong>${q.answerIndex+1}</strong>ë²ˆ<br>${renderRich(q.explanation)}</div>`;
      });
      choicesEl.appendChild(item);
    });

    card.querySelector('#prevBtn').addEventListener('click',()=>{
      state.current = Math.max(0, state.current-1); render();
    });
    card.querySelector('#nextBtn').addEventListener('click',()=>{
      state.current = Math.min(state.data.questions.length-1, state.current+1); render();
    });
    card.querySelector('#homeBtn').addEventListener('click', showHome);
  }

  function renderExam(area){
    const header = document.createElement('div');
    header.className='nav-row';
    header.innerHTML = `
      <button class="ghost" id="backHome">í™ˆìœ¼ë¡œ</button>
      <div style="flex:1"></div>
      <button class="primary" id="btnGradeTop">ì±„ì í•˜ê¸°</button>`;
    area.appendChild(header);

    state.shownPassageId = null;

    state.data.questions.forEach((q,idx)=>{
      // ì§€ë¬¸: ê°™ì€ passageIdê°€ ì—°ì†ë˜ë©´ í•œ ë²ˆë§Œ ì¶œë ¥
      if(q.passageId && q.passageId !== state.shownPassageId){
        const p = state.data.passagesById[q.passageId];
        area.insertAdjacentHTML('beforeend', renderPassageBlock(p));
        state.shownPassageId = q.passageId;
      }

      const card = document.createElement('div');
      card.className = 'question';
      card.dataset.index = idx;
      card.innerHTML = `
        <div class="q-head"><div class="q-num">ë¬¸í•­ ${q.number}</div></div>
        <div class="stem">${renderRich(q.stem)}</div>
        <div class="choices"></div>
        <div class="explain hidden"></div>
      `;
      area.appendChild(card);

      const choicesEl = card.querySelector('.choices');
      q.choices.forEach((c,i)=>{
        const item = document.createElement('div');
        item.className = 'choice';
        item.innerHTML = renderRich(c);
        item.addEventListener('click',()=>{
          state.answers[idx] = i;
          Array.from(choicesEl.children).forEach(ch=>ch.classList.remove('selected'));
          item.classList.add('selected');
        });
        choicesEl.appendChild(item);
      });
    });

    function grade(){
      let correct = 0; const wrongList = [];
      state.data.questions.forEach((q,idx)=>{
        const card = area.querySelector(`.question[data-index="${idx}"]`);
        const sel = state.answers[idx];
        const chs = card.querySelectorAll('.choice');
        chs.forEach(ch=>ch.classList.remove('correct','incorrect'));
        if(sel===q.answerIndex){
          correct++;
          if(chs[sel]) chs[sel].classList.add('correct');
        } else {
          if(typeof sel==='number' && chs[sel]) chs[sel].classList.add('incorrect');
          if(chs[q.answerIndex]) chs[q.answerIndex].classList.add('correct');
          wrongList.push(q.number);
          const ex = card.querySelector('.explain');
          ex.classList.remove('hidden');
          ex.innerHTML = `<div><strong>ì •ë‹µ: ${q.answerIndex+1}</strong><br>${renderRich(q.explanation)}</div>`;
        }
      });

      const sum = document.createElement('div');
      sum.className='question';
      sum.innerHTML = `<div class="q-head">
        <div><strong>ì±„ì  ê²°ê³¼</strong></div>
        <div class="muted">ì ìˆ˜: ${correct} / ${state.data.questions.length}</div>
      </div>`;
      const summary = document.createElement('div');
      summary.className='summary';

      if(wrongList.length===0){
        summary.innerHTML = '<span class="badge good">ì „ë¶€ ì •ë‹µì…ë‹ˆë‹¤! í›Œë¥­í•´ìš” ğŸ‘</span>';
      } else {
        summary.innerHTML = '<span class="muted">í‹€ë¦° ë¬¸í•­:</span>' + wrongList.map(n=>`<span class="badge bad" data-go="${n}">${n}ë²ˆ</span>`).join('');
      }
      sum.appendChild(summary);
      area.prepend(sum);

      // í´ë¦­ ì‹œ ìŠ¤í¬ë¡¤ ì´ë™
      sum.addEventListener('click', (e)=>{
        const el = e.target.closest('.badge.bad');
        if(!el) return;
        const n = parseInt(el.dataset.go,10);
        const idx = state.data.questions.findIndex(q=>q.number===n);
        const card = area.querySelector(`.question[data-index="${idx}"]`);
        if(card) card.scrollIntoView({behavior:'smooth', block:'start'});
      });
    }

    $('#btnGradeTop').addEventListener('click', grade);
    $('#btnGradeBottom').addEventListener('click', grade);
    $('#backHome').addEventListener('click', showHome);
    $('#btnBackHome2').addEventListener('click', showHome);
  }

  // boot: try load default set so ê²€ìƒ‰ ì—†ì´ë„ í…ŒìŠ¤íŠ¸ ê°€ëŠ¥
  loadDefaultPath().then(json=>{ if(json){ onDataLoaded(json, `${json.meta.year} ${json.meta.round} ${json.meta.subject}`); showHome(); }});
})();
</script>
</body>
</html>
